<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Asyncio 我的理解  __await__ 协议是啥？ 为啥Awaitable，Coroutine，Future，Task都有 __await__ asyncio 调用栈都有哪些,具体包含那几部  Awaitable源码1234567891011121314class Awaitable(metaclass&#x3D;ABCMeta):    __slots__ &#x3D; ()    @abstractmet">
<meta property="og:type" content="article">
<meta property="og:title" content="asyncio剖析—认识awaitable(一)">
<meta property="og:url" content="http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/index.html">
<meta property="og:site_name" content="yuan lang">
<meta property="og:description" content="Asyncio 我的理解  __await__ 协议是啥？ 为啥Awaitable，Coroutine，Future，Task都有 __await__ asyncio 调用栈都有哪些,具体包含那几部  Awaitable源码1234567891011121314class Awaitable(metaclass&#x3D;ABCMeta):    __slots__ &#x3D; ()    @abstractmet">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-05-18T07:19:23.425Z">
<meta property="article:modified_time" content="2025-05-18T07:19:23.425Z">
<meta property="article:author" content="yuan lang">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>asyncio剖析—认识awaitable(一)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/categories/">categories</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/05/18/python-asyncio%E2%80%94Task%E4%BD%9C%E7%94%A8(%E4%BA%8C)/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/05/18/python-scrapy-scrapy%E5%A6%82%E4%BD%95%E5%BE%AA%E7%8E%AF(3)/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&text=asyncio剖析—认识awaitable(一)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&is_video=false&description=asyncio剖析—认识awaitable(一)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=asyncio剖析—认识awaitable(一)&body=Check out this article: http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&name=asyncio剖析—认识awaitable(一)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&t=asyncio剖析—认识awaitable(一)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Awaitable%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">Awaitable源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Coroutine%E6%BA%90%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">Coroutine源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Future%E6%BA%90%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">Future源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Task%E6%BA%90%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">Task源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%981-Awaitable-obj"><span class="toc-number">5.</span> <span class="toc-text">问题1 Awaitable obj</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C-asyncio-%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">6.</span> <span class="toc-text">问题二 asyncio 调用栈</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        asyncio剖析—认识awaitable(一)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">yuan lang</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-05-18T07:19:23.425Z" class="dt-published" itemprop="datePublished">2025-05-18</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/code-python/">code-python</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/python/" rel="tag">python</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>Asyncio 我的理解</p>
<ol>
<li>__await__ 协议是啥？ 为啥Awaitable，Coroutine，Future，Task都有 __await__</li>
<li>asyncio 调用栈都有哪些,具体包含那几部</li>
</ol>
<h1 id="Awaitable源码"><a href="#Awaitable源码" class="headerlink" title="Awaitable源码"></a>Awaitable源码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Awaitable(metaclass=ABCMeta):</span><br><span class="line"></span><br><span class="line">    __slots__ = ()</span><br><span class="line"></span><br><span class="line">    @abstractmethod</span><br><span class="line">    def __await__(self):</span><br><span class="line">        yield</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def __subclasshook__(cls, C):</span><br><span class="line">        if cls is Awaitable:</span><br><span class="line">            return _check_methods(C, &quot;__await__&quot;)</span><br><span class="line">        return NotImplemented</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Coroutine源码"><a href="#Coroutine源码" class="headerlink" title="Coroutine源码"></a>Coroutine源码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">class Coroutine(Awaitable):</span><br><span class="line"></span><br><span class="line">    __slots__ = ()</span><br><span class="line"></span><br><span class="line">    @abstractmethod</span><br><span class="line">    def send(self, value):</span><br><span class="line">        &quot;&quot;&quot;Send a value into the coroutine.</span><br><span class="line">        Return next yielded value or raise StopIteration.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        raise StopIteration</span><br><span class="line"></span><br><span class="line">    @abstractmethod</span><br><span class="line">    def throw(self, typ, val=None, tb=None):</span><br><span class="line">        &quot;&quot;&quot;Raise an exception in the coroutine.</span><br><span class="line">        Return next yielded value or raise StopIteration.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if val is None:</span><br><span class="line">            if tb is None:</span><br><span class="line">                raise typ</span><br><span class="line">            val = typ()</span><br><span class="line">        if tb is not None:</span><br><span class="line">            val = val.with_traceback(tb)</span><br><span class="line">        raise val</span><br><span class="line"></span><br><span class="line">    def close(self):</span><br><span class="line">        &quot;&quot;&quot;Raise GeneratorExit inside coroutine.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        try:</span><br><span class="line">            self.throw(GeneratorExit)</span><br><span class="line">        except (GeneratorExit, StopIteration):</span><br><span class="line">            pass</span><br><span class="line">        else:</span><br><span class="line">            raise RuntimeError(&quot;coroutine ignored GeneratorExit&quot;)</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def __subclasshook__(cls, C):</span><br><span class="line">        if cls is Coroutine:</span><br><span class="line">            return _check_methods(C, &#x27;__await__&#x27;, &#x27;send&#x27;, &#x27;throw&#x27;, &#x27;close&#x27;)</span><br><span class="line">        return NotImplemented</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Coroutine.register(coroutine)</span><br></pre></td></tr></table></figure>

<h1 id="Future源码"><a href="#Future源码" class="headerlink" title="Future源码"></a>Future源码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line">class Future:</span><br><span class="line">    &quot;&quot;&quot;This class is *almost* compatible with concurrent.futures.Future.</span><br><span class="line"></span><br><span class="line">    Differences:</span><br><span class="line"></span><br><span class="line">    - This class is not thread-safe.</span><br><span class="line"></span><br><span class="line">    - result() and exception() do not take a timeout argument and</span><br><span class="line">      raise an exception when the future isn&#x27;t done yet.</span><br><span class="line"></span><br><span class="line">    - Callbacks registered with add_done_callback() are always called</span><br><span class="line">      via the event loop&#x27;s call_soon().</span><br><span class="line"></span><br><span class="line">    - This class is not compatible with the wait() and as_completed()</span><br><span class="line">      methods in the concurrent.futures package.</span><br><span class="line"></span><br><span class="line">    (In Python 3.4 or later we may be able to unify the implementations.)</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # Class variables serving as defaults for instance variables.</span><br><span class="line">    _state = _PENDING</span><br><span class="line">    _result = None</span><br><span class="line">    _exception = None</span><br><span class="line">    _loop = None</span><br><span class="line">    _source_traceback = None</span><br><span class="line"></span><br><span class="line">    # This field is used for a dual purpose:</span><br><span class="line">    # - Its presence is a marker to declare that a class implements</span><br><span class="line">    #   the Future protocol (i.e. is intended to be duck-type compatible).</span><br><span class="line">    #   The value must also be not-None, to enable a subclass to declare</span><br><span class="line">    #   that it is not compatible by setting this to None.</span><br><span class="line">    # - It is set by __iter__() below so that Task._step() can tell</span><br><span class="line">    #   the difference between `yield from Future()` (correct) vs.</span><br><span class="line">    #   `yield Future()` (incorrect).</span><br><span class="line">    _asyncio_future_blocking = False</span><br><span class="line"></span><br><span class="line">    _log_traceback = False</span><br><span class="line"></span><br><span class="line">    def __init__(self, *, loop=None):</span><br><span class="line">        &quot;&quot;&quot;Initialize the future.</span><br><span class="line"></span><br><span class="line">        The optional event_loop argument allows explicitly setting the event</span><br><span class="line">        loop object used by the future. If it&#x27;s not provided, the future uses</span><br><span class="line">        the default event loop.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if loop is None:</span><br><span class="line">            self._loop = events.get_event_loop()</span><br><span class="line">        else:</span><br><span class="line">            self._loop = loop</span><br><span class="line">        self._callbacks = []</span><br><span class="line">        if self._loop.get_debug():</span><br><span class="line">            self._source_traceback = events.extract_stack(sys._getframe(1))</span><br><span class="line"></span><br><span class="line">    _repr_info = base_futures._future_repr_info</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return &#x27;&lt;%s %s&gt;&#x27; % (self.__class__.__name__, &#x27; &#x27;.join(self._repr_info()))</span><br><span class="line"></span><br><span class="line">    # On Python 3.3 and older, objects with a destructor part of a reference</span><br><span class="line">    # cycle are never destroyed. It&#x27;s not more the case on Python 3.4 thanks</span><br><span class="line">    # to the PEP 442.</span><br><span class="line">    if compat.PY34:</span><br><span class="line">        def __del__(self):</span><br><span class="line">            if not self._log_traceback:</span><br><span class="line">                # set_exception() was not called, or result() or exception()</span><br><span class="line">                # has consumed the exception</span><br><span class="line">                return</span><br><span class="line">            exc = self._exception</span><br><span class="line">            context = &#123;</span><br><span class="line">                &#x27;message&#x27;: (&#x27;%s exception was never retrieved&#x27;</span><br><span class="line">                            % self.__class__.__name__),</span><br><span class="line">                &#x27;exception&#x27;: exc,</span><br><span class="line">                &#x27;future&#x27;: self,</span><br><span class="line">            &#125;</span><br><span class="line">            if self._source_traceback:</span><br><span class="line">                context[&#x27;source_traceback&#x27;] = self._source_traceback</span><br><span class="line">            self._loop.call_exception_handler(context)</span><br><span class="line"></span><br><span class="line">    def cancel(self):</span><br><span class="line">        &quot;&quot;&quot;Cancel the future and schedule callbacks.</span><br><span class="line"></span><br><span class="line">        If the future is already done or cancelled, return False.  Otherwise,</span><br><span class="line">        change the future&#x27;s state to cancelled, schedule the callbacks and</span><br><span class="line">        return True.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        self._log_traceback = False</span><br><span class="line">        if self._state != _PENDING:</span><br><span class="line">            return False</span><br><span class="line">        self._state = _CANCELLED</span><br><span class="line">        self._schedule_callbacks()</span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">    def _schedule_callbacks(self):</span><br><span class="line">        &quot;&quot;&quot;Internal: Ask the event loop to call all callbacks.</span><br><span class="line"></span><br><span class="line">        The callbacks are scheduled to be called as soon as possible. Also</span><br><span class="line">        clears the callback list.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        callbacks = self._callbacks[:]</span><br><span class="line">        if not callbacks:</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        self._callbacks[:] = []</span><br><span class="line">        for callback in callbacks:</span><br><span class="line">            self._loop.call_soon(callback, self)</span><br><span class="line"></span><br><span class="line">    def cancelled(self):</span><br><span class="line">        &quot;&quot;&quot;Return True if the future was cancelled.&quot;&quot;&quot;</span><br><span class="line">        return self._state == _CANCELLED</span><br><span class="line"></span><br><span class="line">    # Don&#x27;t implement running(); see http://bugs.python.org/issue18699</span><br><span class="line"></span><br><span class="line">    def done(self):</span><br><span class="line">        &quot;&quot;&quot;Return True if the future is done.</span><br><span class="line"></span><br><span class="line">        Done means either that a result / exception are available, or that the</span><br><span class="line">        future was cancelled.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        return self._state != _PENDING</span><br><span class="line"></span><br><span class="line">    def result(self):</span><br><span class="line">        &quot;&quot;&quot;Return the result this future represents.</span><br><span class="line"></span><br><span class="line">        If the future has been cancelled, raises CancelledError.  If the</span><br><span class="line">        future&#x27;s result isn&#x27;t yet available, raises InvalidStateError.  If</span><br><span class="line">        the future is done and has an exception set, this exception is raised.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if self._state == _CANCELLED:</span><br><span class="line">            raise CancelledError</span><br><span class="line">        if self._state != _FINISHED:</span><br><span class="line">            raise InvalidStateError(&#x27;Result is not ready.&#x27;)</span><br><span class="line">        self._log_traceback = False</span><br><span class="line">        if self._exception is not None:</span><br><span class="line">            raise self._exception</span><br><span class="line">        return self._result</span><br><span class="line"></span><br><span class="line">    def exception(self):</span><br><span class="line">        &quot;&quot;&quot;Return the exception that was set on this future.</span><br><span class="line"></span><br><span class="line">        The exception (or None if no exception was set) is returned only if</span><br><span class="line">        the future is done.  If the future has been cancelled, raises</span><br><span class="line">        CancelledError.  If the future isn&#x27;t done yet, raises</span><br><span class="line">        InvalidStateError.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if self._state == _CANCELLED:</span><br><span class="line">            raise CancelledError</span><br><span class="line">        if self._state != _FINISHED:</span><br><span class="line">            raise InvalidStateError(&#x27;Exception is not set.&#x27;)</span><br><span class="line">        self._log_traceback = False</span><br><span class="line">        return self._exception</span><br><span class="line"></span><br><span class="line">    def add_done_callback(self, fn):</span><br><span class="line">        &quot;&quot;&quot;Add a callback to be run when the future becomes done.</span><br><span class="line"></span><br><span class="line">        The callback is called with a single argument - the future object. If</span><br><span class="line">        the future is already done when this is called, the callback is</span><br><span class="line">        scheduled with call_soon.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if self._state != _PENDING:</span><br><span class="line">            self._loop.call_soon(fn, self)</span><br><span class="line">        else:</span><br><span class="line">            self._callbacks.append(fn)</span><br><span class="line"></span><br><span class="line">    # New method not in PEP 3148.</span><br><span class="line"></span><br><span class="line">    def remove_done_callback(self, fn):</span><br><span class="line">        &quot;&quot;&quot;Remove all instances of a callback from the &quot;call when done&quot; list.</span><br><span class="line"></span><br><span class="line">        Returns the number of callbacks removed.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        filtered_callbacks = [f for f in self._callbacks if f != fn]</span><br><span class="line">        removed_count = len(self._callbacks) - len(filtered_callbacks)</span><br><span class="line">        if removed_count:</span><br><span class="line">            self._callbacks[:] = filtered_callbacks</span><br><span class="line">        return removed_count</span><br><span class="line"></span><br><span class="line">    # So-called internal methods (note: no set_running_or_notify_cancel()).</span><br><span class="line"></span><br><span class="line">    def set_result(self, result):</span><br><span class="line">        &quot;&quot;&quot;Mark the future done and set its result.</span><br><span class="line"></span><br><span class="line">        If the future is already done when this method is called, raises</span><br><span class="line">        InvalidStateError.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if self._state != _PENDING:</span><br><span class="line">            raise InvalidStateError(&#x27;&#123;&#125;: &#123;!r&#125;&#x27;.format(self._state, self))</span><br><span class="line">        self._result = result</span><br><span class="line">        self._state = _FINISHED</span><br><span class="line">        self._schedule_callbacks()</span><br><span class="line"></span><br><span class="line">    def set_exception(self, exception):</span><br><span class="line">        &quot;&quot;&quot;Mark the future done and set an exception.</span><br><span class="line"></span><br><span class="line">        If the future is already done when this method is called, raises</span><br><span class="line">        InvalidStateError.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if self._state != _PENDING:</span><br><span class="line">            raise InvalidStateError(&#x27;&#123;&#125;: &#123;!r&#125;&#x27;.format(self._state, self))</span><br><span class="line">        if isinstance(exception, type):</span><br><span class="line">            exception = exception()</span><br><span class="line">        if type(exception) is StopIteration:</span><br><span class="line">            raise TypeError(&quot;StopIteration interacts badly with generators &quot;</span><br><span class="line">                            &quot;and cannot be raised into a Future&quot;)</span><br><span class="line">        self._exception = exception</span><br><span class="line">        self._state = _FINISHED</span><br><span class="line">        self._schedule_callbacks()</span><br><span class="line">        if compat.PY34:</span><br><span class="line">            self._log_traceback = True</span><br><span class="line">        else:</span><br><span class="line">            self._tb_logger = _TracebackLogger(self, exception)</span><br><span class="line">            # Arrange for the logger to be activated after all callbacks</span><br><span class="line">            # have had a chance to call result() or exception().</span><br><span class="line">            self._loop.call_soon(self._tb_logger.activate)</span><br><span class="line"></span><br><span class="line">    def __iter__(self):</span><br><span class="line">        if not self.done():</span><br><span class="line">            self._asyncio_future_blocking = True</span><br><span class="line">            yield self  # This tells Task to wait for completion.</span><br><span class="line">        assert self.done(), &quot;yield from wasn&#x27;t used with future&quot;</span><br><span class="line">        return self.result()  # May raise too.</span><br><span class="line"></span><br><span class="line">    if compat.PY35:</span><br><span class="line">        __await__ = __iter__ # make compatible with &#x27;await&#x27; expression</span><br></pre></td></tr></table></figure>

<h1 id="Task源码"><a href="#Task源码" class="headerlink" title="Task源码"></a>Task源码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line">class Task(futures.Future):</span><br><span class="line">    &quot;&quot;&quot;A coroutine wrapped in a Future.&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # An important invariant maintained while a Task not done:</span><br><span class="line">    #</span><br><span class="line">    # - Either _fut_waiter is None, and _step() is scheduled;</span><br><span class="line">    # - or _fut_waiter is some Future, and _step() is *not* scheduled.</span><br><span class="line">    #</span><br><span class="line">    # The only transition from the latter to the former is through</span><br><span class="line">    # _wakeup().  When _fut_waiter is not None, one of its callbacks</span><br><span class="line">    # must be _wakeup().</span><br><span class="line"></span><br><span class="line">    # Weak set containing all tasks alive.</span><br><span class="line">    _all_tasks = weakref.WeakSet()</span><br><span class="line"></span><br><span class="line">    # Dictionary containing tasks that are currently active in</span><br><span class="line">    # all running event loops.  &#123;EventLoop: Task&#125;</span><br><span class="line">    _current_tasks = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    # If False, don&#x27;t log a message if the task is destroyed whereas its</span><br><span class="line">    # status is still pending</span><br><span class="line">    _log_destroy_pending = True</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def current_task(cls, loop=None):</span><br><span class="line">        &quot;&quot;&quot;Return the currently running task in an event loop or None.</span><br><span class="line"></span><br><span class="line">        By default the current task for the current event loop is returned.</span><br><span class="line"></span><br><span class="line">        None is returned when called not in the context of a Task.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if loop is None:</span><br><span class="line">            loop = events.get_event_loop()</span><br><span class="line">        return cls._current_tasks.get(loop)</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def all_tasks(cls, loop=None):</span><br><span class="line">        &quot;&quot;&quot;Return a set of all tasks for an event loop.</span><br><span class="line"></span><br><span class="line">        By default all tasks for the current event loop are returned.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if loop is None:</span><br><span class="line">            loop = events.get_event_loop()</span><br><span class="line">        return &#123;t for t in cls._all_tasks if t._loop is loop&#125;</span><br><span class="line"></span><br><span class="line">    def __init__(self, coro, *, loop=None):</span><br><span class="line">        assert coroutines.iscoroutine(coro), repr(coro)</span><br><span class="line">        super().__init__(loop=loop)</span><br><span class="line">        if self._source_traceback:</span><br><span class="line">            del self._source_traceback[-1]</span><br><span class="line">        self._coro = coro</span><br><span class="line">        self._fut_waiter = None</span><br><span class="line">        self._must_cancel = False</span><br><span class="line">        self._loop.call_soon(self._step)</span><br><span class="line">        self.__class__._all_tasks.add(self)</span><br><span class="line"></span><br><span class="line">    # On Python 3.3 or older, objects with a destructor that are part of a</span><br><span class="line">    # reference cycle are never destroyed. That&#x27;s not the case any more on</span><br><span class="line">    # Python 3.4 thanks to the PEP 442.</span><br><span class="line">    if compat.PY34:</span><br><span class="line">        def __del__(self):</span><br><span class="line">            if self._state == futures._PENDING and self._log_destroy_pending:</span><br><span class="line">                context = &#123;</span><br><span class="line">                    &#x27;task&#x27;: self,</span><br><span class="line">                    &#x27;message&#x27;: &#x27;Task was destroyed but it is pending!&#x27;,</span><br><span class="line">                &#125;</span><br><span class="line">                if self._source_traceback:</span><br><span class="line">                    context[&#x27;source_traceback&#x27;] = self._source_traceback</span><br><span class="line">                self._loop.call_exception_handler(context)</span><br><span class="line">            futures.Future.__del__(self)</span><br><span class="line"></span><br><span class="line">    def _repr_info(self):</span><br><span class="line">        return base_tasks._task_repr_info(self)</span><br><span class="line"></span><br><span class="line">    def get_stack(self, *, limit=None):</span><br><span class="line">        &quot;&quot;&quot;Return the list of stack frames for this task&#x27;s coroutine.</span><br><span class="line"></span><br><span class="line">        If the coroutine is not done, this returns the stack where it is</span><br><span class="line">        suspended.  If the coroutine has completed successfully or was</span><br><span class="line">        cancelled, this returns an empty list.  If the coroutine was</span><br><span class="line">        terminated by an exception, this returns the list of traceback</span><br><span class="line">        frames.</span><br><span class="line"></span><br><span class="line">        The frames are always ordered from oldest to newest.</span><br><span class="line"></span><br><span class="line">        The optional limit gives the maximum number of frames to</span><br><span class="line">        return; by default all available frames are returned.  Its</span><br><span class="line">        meaning differs depending on whether a stack or a traceback is</span><br><span class="line">        returned: the newest frames of a stack are returned, but the</span><br><span class="line">        oldest frames of a traceback are returned.  (This matches the</span><br><span class="line">        behavior of the traceback module.)</span><br><span class="line"></span><br><span class="line">        For reasons beyond our control, only one stack frame is</span><br><span class="line">        returned for a suspended coroutine.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        return base_tasks._task_get_stack(self, limit)</span><br><span class="line"></span><br><span class="line">    def print_stack(self, *, limit=None, file=None):</span><br><span class="line">        &quot;&quot;&quot;Print the stack or traceback for this task&#x27;s coroutine.</span><br><span class="line"></span><br><span class="line">        This produces output similar to that of the traceback module,</span><br><span class="line">        for the frames retrieved by get_stack().  The limit argument</span><br><span class="line">        is passed to get_stack().  The file argument is an I/O stream</span><br><span class="line">        to which the output is written; by default output is written</span><br><span class="line">        to sys.stderr.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        return base_tasks._task_print_stack(self, limit, file)</span><br><span class="line"></span><br><span class="line">    def cancel(self):</span><br><span class="line">        &quot;&quot;&quot;Request that this task cancel itself.</span><br><span class="line"></span><br><span class="line">        This arranges for a CancelledError to be thrown into the</span><br><span class="line">        wrapped coroutine on the next cycle through the event loop.</span><br><span class="line">        The coroutine then has a chance to clean up or even deny</span><br><span class="line">        the request using try/except/finally.</span><br><span class="line"></span><br><span class="line">        Unlike Future.cancel, this does not guarantee that the</span><br><span class="line">        task will be cancelled: the exception might be caught and</span><br><span class="line">        acted upon, delaying cancellation of the task or preventing</span><br><span class="line">        cancellation completely.  The task may also return a value or</span><br><span class="line">        raise a different exception.</span><br><span class="line"></span><br><span class="line">        Immediately after this method is called, Task.cancelled() will</span><br><span class="line">        not return True (unless the task was already cancelled).  A</span><br><span class="line">        task will be marked as cancelled when the wrapped coroutine</span><br><span class="line">        terminates with a CancelledError exception (even if cancel()</span><br><span class="line">        was not called).</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        self._log_traceback = False</span><br><span class="line">        if self.done():</span><br><span class="line">            return False</span><br><span class="line">        if self._fut_waiter is not None:</span><br><span class="line">            if self._fut_waiter.cancel():</span><br><span class="line">                # Leave self._fut_waiter; it may be a Task that</span><br><span class="line">                # catches and ignores the cancellation so we may have</span><br><span class="line">                # to cancel it again later.</span><br><span class="line">                return True</span><br><span class="line">        # It must be the case that self._step is already scheduled.</span><br><span class="line">        self._must_cancel = True</span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">    def _step(self, exc=None):</span><br><span class="line">        assert not self.done(), \</span><br><span class="line">            &#x27;_step(): already done: &#123;!r&#125;, &#123;!r&#125;&#x27;.format(self, exc)</span><br><span class="line">        if self._must_cancel:</span><br><span class="line">            if not isinstance(exc, futures.CancelledError):</span><br><span class="line">                exc = futures.CancelledError()</span><br><span class="line">            self._must_cancel = False</span><br><span class="line">        coro = self._coro</span><br><span class="line">        self._fut_waiter = None</span><br><span class="line"></span><br><span class="line">        self.__class__._current_tasks[self._loop] = self</span><br><span class="line">        # Call either coro.throw(exc) or coro.send(None).</span><br><span class="line">        try:</span><br><span class="line">            if exc is None:</span><br><span class="line">                # We use the `send` method directly, because coroutines</span><br><span class="line">                # don&#x27;t have `__iter__` and `__next__` methods.</span><br><span class="line">                result = coro.send(None)</span><br><span class="line">            else:</span><br><span class="line">                result = coro.throw(exc)</span><br><span class="line">        except StopIteration as exc:</span><br><span class="line">            if self._must_cancel:</span><br><span class="line">                # Task is cancelled right before coro stops.</span><br><span class="line">                self._must_cancel = False</span><br><span class="line">                self.set_exception(futures.CancelledError())</span><br><span class="line">            else:</span><br><span class="line">                self.set_result(exc.value)</span><br><span class="line">        except futures.CancelledError:</span><br><span class="line">            super().cancel()  # I.e., Future.cancel(self).</span><br><span class="line">        except Exception as exc:</span><br><span class="line">            self.set_exception(exc)</span><br><span class="line">        except BaseException as exc:</span><br><span class="line">            self.set_exception(exc)</span><br><span class="line">            raise</span><br><span class="line">        else:</span><br><span class="line">            blocking = getattr(result, &#x27;_asyncio_future_blocking&#x27;, None)</span><br><span class="line">            if blocking is not None:</span><br><span class="line">                # Yielded Future must come from Future.__iter__().</span><br><span class="line">                if result._loop is not self._loop:</span><br><span class="line">                    self._loop.call_soon(</span><br><span class="line">                        self._step,</span><br><span class="line">                        RuntimeError(</span><br><span class="line">                            &#x27;Task &#123;!r&#125; got Future &#123;!r&#125; attached to a &#x27;</span><br><span class="line">                            &#x27;different loop&#x27;.format(self, result)))</span><br><span class="line">                elif blocking:</span><br><span class="line">                    if result is self:</span><br><span class="line">                        self._loop.call_soon(</span><br><span class="line">                            self._step,</span><br><span class="line">                            RuntimeError(</span><br><span class="line">                                &#x27;Task cannot await on itself: &#123;!r&#125;&#x27;.format(</span><br><span class="line">                                    self)))</span><br><span class="line">                    else:</span><br><span class="line">                        result._asyncio_future_blocking = False</span><br><span class="line">                        result.add_done_callback(self._wakeup)</span><br><span class="line">                        self._fut_waiter = result</span><br><span class="line">                        if self._must_cancel:</span><br><span class="line">                            if self._fut_waiter.cancel():</span><br><span class="line">                                self._must_cancel = False</span><br><span class="line">                else:</span><br><span class="line">                    self._loop.call_soon(</span><br><span class="line">                        self._step,</span><br><span class="line">                        RuntimeError(</span><br><span class="line">                            &#x27;yield was used instead of yield from &#x27;</span><br><span class="line">                            &#x27;in task &#123;!r&#125; with &#123;!r&#125;&#x27;.format(self, result)))</span><br><span class="line">            elif result is None:</span><br><span class="line">                # Bare yield relinquishes control for one event loop iteration.</span><br><span class="line">                self._loop.call_soon(self._step)</span><br><span class="line">            elif inspect.isgenerator(result):</span><br><span class="line">                # Yielding a generator is just wrong.</span><br><span class="line">                self._loop.call_soon(</span><br><span class="line">                    self._step,</span><br><span class="line">                    RuntimeError(</span><br><span class="line">                        &#x27;yield was used instead of yield from for &#x27;</span><br><span class="line">                        &#x27;generator in task &#123;!r&#125; with &#123;!r&#125;&#x27;.format(</span><br><span class="line">                            self, result)))</span><br><span class="line">            else:</span><br><span class="line">                # Yielding something else is an error.</span><br><span class="line">                self._loop.call_soon(</span><br><span class="line">                    self._step,</span><br><span class="line">                    RuntimeError(</span><br><span class="line">                        &#x27;Task got bad yield: &#123;!r&#125;&#x27;.format(result)))</span><br><span class="line">        finally:</span><br><span class="line">            self.__class__._current_tasks.pop(self._loop)</span><br><span class="line">            self = None  # Needed to break cycles when an exception occurs.</span><br><span class="line"></span><br><span class="line">    def _wakeup(self, future):</span><br><span class="line">        try:</span><br><span class="line">            future.result()</span><br><span class="line">        except Exception as exc:</span><br><span class="line">            # This may also be a cancellation.</span><br><span class="line">            self._step(exc)</span><br><span class="line">        else:</span><br><span class="line">            # Don&#x27;t pass the value of `future.result()` explicitly,</span><br><span class="line">            # as `Future.__iter__` and `Future.__await__` don&#x27;t need it.</span><br><span class="line">            # If we call `_step(value, None)` instead of `_step()`,</span><br><span class="line">            # Python eval loop would use `.send(value)` method call,</span><br><span class="line">            # instead of `__next__()`, which is slower for futures</span><br><span class="line">            # that return non-generator iterators from their `__iter__`.</span><br><span class="line">            self._step()</span><br><span class="line">        self = None  # Needed to break cycles when an exception occurs.</span><br></pre></td></tr></table></figure>
<h1 id="问题1-Awaitable-obj"><a href="#问题1-Awaitable-obj" class="headerlink" title="问题1 Awaitable obj"></a>问题1 Awaitable obj</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Coroutine 继承Awaitable</span><br><span class="line">Future 实现__await__ 协议</span><br><span class="line">        if compat.PY35:</span><br><span class="line">        __await__ = __iter__ # make compatible with &#x27;await&#x27; expression</span><br><span class="line">Task 继承Future</span><br><span class="line"></span><br><span class="line">我的理解 所有 Awaitable都可以变为coroutine</span><br><span class="line"></span><br><span class="line">tasks.py 中如下：</span><br><span class="line">@coroutine</span><br><span class="line">def _wrap_awaitable(awaitable):</span><br><span class="line">    &quot;&quot;&quot;Helper for asyncio.ensure_future().</span><br><span class="line"></span><br><span class="line">    Wraps awaitable (an object with __await__) into a coroutine</span><br><span class="line">    that will later be wrapped in a Task by ensure_future().</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    return (yield from awaitable.__await__())</span><br></pre></td></tr></table></figure>

<h1 id="问题二-asyncio-调用栈"><a href="#问题二-asyncio-调用栈" class="headerlink" title="问题二 asyncio 调用栈"></a>问题二 asyncio 调用栈</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">asyncio 调用栈</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop() #根据操作系统生成select轮询 命名loop</span><br><span class="line">                |</span><br><span class="line">                |</span><br><span class="line">                |</span><br><span class="line">                v</span><br><span class="line">asyncio.ensure_future(start_server) </span><br><span class="line">                | 函数作用：</span><br><span class="line">                | 1.future直接返回</span><br><span class="line">                | 2.iscoroutine封装成task</span><br><span class="line">                | 3.__await__对象 调用_wrap_awaitable封装成coroutine</span><br><span class="line">                | </span><br><span class="line">                v</span><br><span class="line">        task = tasks.Task(coro, loop=self) </span><br><span class="line">                |</span><br><span class="line">                |</span><br><span class="line">                | self=loop,callback是coro包装成的TaskStepMethWrapper</span><br><span class="line">                |</span><br><span class="line">                v</span><br><span class="line">        handle = events.Handle(callback, args, self) #将task封装成event 放入loop 循环中</span><br><span class="line">        yeild future 挂起future自身等待轮询</span><br><span class="line">                |</span><br><span class="line">                | 重点（类似代码）：</span><br><span class="line">                |    self.coro.send(future.result) #初始化task，启动协程</span><br><span class="line">                |                  |</span><br><span class="line">                |                  v</span><br><span class="line">                |    yield from connect(sock, (&#x27;example.com&#x27;, 80)) #委托生成器到connect</span><br><span class="line">                |                  |</span><br><span class="line">                |                  v</span><br><span class="line">                |    selector.register(sock.fileno(), EVENT_WRITE,on_connected) #注册event 到loop</span><br><span class="line">                |    yield from f #委托生成器到future </span><br><span class="line">                |                  |</span><br><span class="line">                |                  v</span><br><span class="line">                |        def __iter__(self):</span><br><span class="line">                |            yield self  #挂起future自己，直到loop轮询过来进入下一步</span><br><span class="line">                |            return self.result</span><br><span class="line">                |</span><br><span class="line">                |</span><br><span class="line">                v</span><br><span class="line">        return task</span><br><span class="line">                |</span><br><span class="line">                |</span><br><span class="line">                |</span><br><span class="line">                |</span><br><span class="line">                v</span><br><span class="line">loop.run_until_complete() 启动loop</span><br></pre></td></tr></table></figure>
<ul>
<li>国外大神剖析 <a target="_blank" rel="noopener" href="http://aosabook.org/en/500L/a-web-crawler-with-asyncio-coroutines.html">http://aosabook.org/en/500L/a-web-crawler-with-asyncio-coroutines.html</a></li>
<li>学习博客 <a target="_blank" rel="noopener" href="https://hatboy.github.io/archives/page/2/">https://hatboy.github.io/archives/page/2/</a></li>
<li>github async demo：<a target="_blank" rel="noopener" href="https://github.com/langgithub/async-aiotutorial">https://github.com/langgithub/async-aiotutorial</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/categories/">categories</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Awaitable%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">Awaitable源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Coroutine%E6%BA%90%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">Coroutine源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Future%E6%BA%90%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">Future源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Task%E6%BA%90%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">Task源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%981-Awaitable-obj"><span class="toc-number">5.</span> <span class="toc-text">问题1 Awaitable obj</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C-asyncio-%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">6.</span> <span class="toc-text">问题二 asyncio 调用栈</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&text=asyncio剖析—认识awaitable(一)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&is_video=false&description=asyncio剖析—认识awaitable(一)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=asyncio剖析—认识awaitable(一)&body=Check out this article: http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&title=asyncio剖析—认识awaitable(一)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&name=asyncio剖析—认识awaitable(一)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/05/18/python-asyncio%E2%80%94%E8%AE%A4%E8%AF%86awaitable(%E4%B8%80)/&t=asyncio剖析—认识awaitable(一)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    yuan lang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/categories/">categories</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
